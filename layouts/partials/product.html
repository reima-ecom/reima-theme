{{ $product := partial "helpers/get-product" . }}
{{ $settings := partial "helpers/get-locale-data" "productpage" }}

{{ with $product }}

<div class="product">
  <div>
    {{ $imgs := .Resources.ByType "image" }}
    {{ if templates.Exists "partials/get-variant-images.html" }}
    {{ $variantSkus := apply .Params.variants "index" "." "sku" }}
    {{ $imgs = partial "get-variant-images" $variantSkus }}
    {{ end }}
    <r-carousel thumbnails="r-thumbnails">
      <div>
        <!-- sizes: roughly 100vw up to 768px, 40vw but max 536px after that -->
        {{ $sizes := "(min-width: 768px) min(40vw, 536px), 100vw" }}
        {{ with index $imgs 0 }}
        <img srcset="{{partial "srcset" (dict "image" . "widths" "375,750")}}" src="{{(.Resize "375x").RelPermalink}}"
          height="{{.Height}}" width="{{.Width}}" sizes="{{$sizes}}" data-index="{{.Name}}" />
        {{ end }}
        {{ range after 1 $imgs }}
        {{partial "image" (dict "image" . "widths" "375,750" "sizes" $sizes "dataset" (dict "index" .Name))}}
        {{ end }}
      </div>
      {{ if gt (len $imgs) 1 }}
      <button prev></button>
      <button next></button>
      {{ end }}
    </r-carousel>
    <r-thumbnails carousel="r-carousel">
      {{ range $imgs }}
      {{ $sizes := "(min-width: 768px) min(6vw, 82px), 15vw" }}
      {{partial "image" (dict "image" . "widths" "100,200" "sizes" $sizes "dataset" (dict "index" .Name))}}
      {{ end }}
    </r-thumbnails>
  </div>

  <!-- find first available variant options -->
  {{ if not .Params.variants }}
  {{ errorf "%s has no variants" .File.ContentBaseName }}
  {{ end }}
  {{ $firstAvailableVariant := index (where .Params.variants "available" true | first 1) 0 }}
  {{ $firstAvailableOptions := $firstAvailableVariant.options }}

  <div>

    <form action="/cart" method="POST" data-variant="{{$firstAvailableVariant.id}}" id="product-form">
      <!-- TODO: DEPRECATED -->
      <input type="hidden" name="product-id"
        value="{{printf "gid://shopify/Product/%s" .Params.yotpoId | base64Encode}}">
      <h1 class="g-h2" id="product-name">
        {{.Title}}
      </h1>
      <div class="product-prices">
        {{ with $firstAvailableVariant }}
        {{partial "product-price" .}}
        {{ else }}
        {{partial "product-price" .Params}}
        {{ end }}
        {{ with partial "helpers/get-reviews-bottomline" $product.Params.yotpoId }}
        <div>
          <a href="#reviews" class="silent-link">
            {{ range seq (math.Round .average) }}â˜…{{ end }} {{ div (math.Round (mul .average 10)) 10 }} ({{.count}})
          </a>
        </div>
        {{ end }}
      </div>

      <hr>

      {{ range $product.Params.options }}
      {{ $name := .name }}
      {{ $nameEnglish := $name }}
      <!-- see if this is color, and change class name if yes -->
      {{ if eq $nameEnglish site.Params.coloroption }}
      {{ $nameEnglish = "Color" }}
      {{ end }}
      <fieldset class="selections selections--{{$nameEnglish}}">
        <legend>{{.name}}<span id="selected-{{$name}}">{{.firstAvailable}}</span></legend>
        <ul>
          {{ range .values }}
          <li>
            {{ $id := printf "%s-%s" $name .value}}
            <input type="radio" name="{{$name}}" id="{{$id}}" value="{{.value}}"
              {{ if .firstAvailable }}checked{{ end }} />

            {{ $labelStyle := "" }}
            {{ $swatch := "" }}
            {{ if eq $nameEnglish "Color" }}
            {{ with partial "helpers/get-color" .value }}
            {{ with .color }}
            {{ $labelStyle = printf "style=\"background-color: %s;\"" . }}
            {{ end }}
            {{ $swatch = .image }}
            {{ end }}
            {{ end }}

            <label {{with $labelStyle}}{{. | safeHTMLAttr}}{{end}} for="{{$id}}"
              {{ if not .availableInitially }}class="unavailable" {{ end }}>
              <span>{{.value}}</span>
              {{ if $swatch }}
              <img src="{{$swatch}}" alt="{{.value}}">
              {{ end }}
            </label>
          </li>
          {{ end }}
        </ul>
      </fieldset>
      {{ end }}

      <div>
        <button type="submit" class="btn btn--cta btn--lg product__add-to-cart"
          {{if not $firstAvailableOptions}}disabled{{end}} data-add="{{T "Add to cart"}}" data-sold="{{T "Sold out"}}"
          data-na="{{T "Not available"}}">
          {{ if $firstAvailableOptions }}
          {{T "Add to cart"}}
          {{ else }}
          {{T "Sold out"}}
          {{ end }}
        </button>
        {{ if $settings.klarnabanner }}
        {{ $payment := printf "$%.2f" (float (div .Params.price 4)) }}
        <div class="product__klarna-banner">
          <img src="/klarna.svg" alt="Klarna logo" width="54" height="30">
          <div>
            4 interest free payments of {{$payment}}. <a
              href="https://cdn.klarna.com/1.0/shared/content/legal/terms/0/en_us/sliceitinx" target="_blank"
              rel="noopener">Learn more</a>
          </div>
        </div>
        {{ end }}
        <div class="product__payment-logos">
          {{- range $settings.paymentlogos }}
          {{ if eq .type "External SVG" }}
          <img src="{{.src}}" alt="{{.name}}">
          {{ end }}
          {{ end -}}
        </div>
      </div>
    </form>

    <div>
      {{ $productFields := split .RawContent "[product]" }}
      {{ $productMain := split (index $productFields 0) "[--Read More--]" }}
      {{ $productDescription := index $productMain 0 }}
      {{ $productReadMore := index $productMain 1 }}

      {{$productDescription | safeHTML}}

      {{ with $productReadMore }}
      <details class="read-more">
        {{$productReadMore | safeHTML}}
        <summary class="link link--no-color">
          <span class="more">{{T "Show More"}}</span>
          <span class="less">{{T "Show Less"}}</span>
        </summary>
      </details>
      {{ end }}

      {{ range $settings.links }}
      {{ if eq .type "link" }}
      <p><a class="link--no-color" href="{{.link}}" target="_blank">{{.title}}</a></p>
      {{ else if eq .type "modal" }}
      {{ $id := .title }}
      <p><a class="link--no-color" href="#" openid="{{$id}}">{{.title}}</a></p>
      <div class="modal" id="{{$id}}">
        <div>
          <button class="icon" close>
            <svg>
              <use xlink:href="#icon-close"></use>
            </svg>
          </button>
          {{.content | markdownify}}
        </div>
      </div>
      {{ else }}
      {{ warnf "Wrong link type %s at %s" .type $ }}
      {{ end }}
      {{ end }}
    </div>
  </div>
</div>

<section class="tabs">
  {{ range after 1 $productFields }}
  <div class="tab">
    {{ $field := trim (substr . 0 6) "[]" }}
    {{ $contents := substr . 6 }}
    <!-- tabs -->
    <input type="radio" name="tab" id="tab-{{$field}}" {{if eq $field "info"}}checked{{end}}>
    <input type="checkbox" name="acc-{{$field}}" id="acc-{{$field}}">
    <label for="tab-{{$field}}">{{index $settings.accordion $field}}</label>
    <label for="acc-{{$field}}">{{index $settings.accordion $field}}</label>
    <aside>
      <div>
        {{$contents | safeHTML}}
      </div>
      <!-- if this is the info/features section, show tag-based features -->
      {{ if eq $field "info" }}
      <div class="features">
        {{ range $product.Params.tags }}
        {{ $tagData := split . ":" }}
        {{ $tag := index $tagData 0 }}
        {{ $value := index $tagData 1 }}
        <!-- get feature for this tag if exists -->
        {{ range where $settings.features "tag" $tag }}
        {{ $modalid := .title }}
        <!-- feature heading with modal link if modal exists -->
        <div>
          <h3 class="features__heading">
            {{ if .modal }}
            <a href="#" openid="{{$modalid}}" class="silent-link">
              {{.title}}
            </a>
            {{ else }}
            {{.title}}
            {{ end }}
          </h3>
        </div>
        <!-- modal if specified -->
        {{ with .modal }}
        <div class="modal" id="{{$modalid}}">
          <div>
            <button class="icon" close>
              <svg>
                <use xlink:href="#icon-close"></use>
              </svg>
            </button>
            {{. | markdownify}}
          </div>
        </div>
        {{ end }}
        <!-- icons -->
        {{ range .values }}
        {{ $iconValue := .value }}
        {{ with partial "helpers/get-image" .icon }}
        {{ $svg := .Content }}
        {{ if eq $iconValue $value }}
        {{ $svg = replace $svg "<svg" "<svg class=\"active\"" }}
        {{ end }}
        {{$svg | safeHTML}}
        {{ end }}
        {{ end }}
        <!-- tag description e.g. "Waterproof level 8000 mm" -->
        <p>
          {{ replace .description "VALUE" $value }}
        </p>
        {{ end }}
        {{ end }}
      </div>
      {{ end }}
    </aside>
  </div>
  {{ end }}
  {{ if $settings.reviews }}
  <div class="tab">
    <!-- we need a separate element for the anchor b/c .tab is display:content on desktop -->
    <a id="reviews"></a>
    <input type="radio" name="tab" id="tab-reviews">
    <input type="checkbox" name="acc-reviews" id="acc-reviews">
    <label for="tab-reviews">{{T "Reviews"}}</label>
    <label for="acc-reviews">{{T "Reviews"}}</label>
    <aside>
      {{partial "product-reviews" $product}}
    </aside>
  </div>
  {{ end }}
</section>

{{ $selectedOptions := dict }}
{{ with $firstAvailableOptions }}
{{ $selectedOptions = . }}
{{ end }}
<script>
  handle = '{{.File.ContentBaseName}}';
  variants = {{.Params.variants }};
  yotpoId = '{{.Params.yotpoId}}';
  selectedOptions = {{ $selectedOptions }};
  priceTemplate = '{{T "Product price" (dict "price" "PRICE")}}';
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": {{.Title}},
  {{- with .Resources.ByType "image" }}
  {{- with index . 0 }}
  "image": [
    "{{(.Resize "800x").Permalink}}"
  ],
  {{- end }}
  {{- end }}
  "description": {{.Description}},
  "sku": "{{.Params.handle}}",
  "brand": {
    "@type": "Brand",
    "name": "Reima"
  },
  {{- with .Params.reviewsBottomline }}
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{.average}}",
    "reviewCount": "{{.count}}"
  },
  {{- end }}
  "offers": {
    "@type": "Offer",
    "url": "{{partial "link" .Permalink}}",
    "priceCurrency": "{{site.Params.public.currency}}",
    "price": "{{.Params.price}}",
    "availability": "https://schema.org/{{if .Params.available}}InStock{{else}}SoldOut{{end}}",
    "seller": {
      "@type": "Organization",
      "name": "Reima USA"
    }
  }
}
</script>

{{ end }}
